---

- name: DNSMasq | package
  tags:
    - package
  package:
    name:
      - dnsmasq
      - dnsmasq-utils

- name: DNSMasq | config subdirs
  tags:
    - dir
  file:
    path: "{{ dnsmasq_conf_dir }}/{{ item }}"
    state: directory
    group: "{{ dnsmasq_group }}"
    mode: "0750"
  loop: "{{ dnsmasq_dirs }}"

- name: DNSmasq | static config
  tags:
  - config
  template:
    src : "{{ item.src }}.j2"
    dest: "{{ item.dest }}/{{ item.src }}"
    group: "{{ dnsmasq_group }}"
    mode: "0640"
  loop:
    - { src: dnsmasq.conf, dest: /etc }
    - { src: dnsmasq, dest: /etc/default }
    - { src: servers, dest: "{{ dnsmasq_conf_dir }}" }
  notify: restart dnsmasq

# Config in subdirs can be updated without restart
- name: DNSmasq | dynamic config in subdirs
  tags:
    - config
  template:
    src : "{{ item }}.j2"
    dest: "{{ dnsmasq_conf_dir }}/{{ item }}/main"
    group: "{{ dnsmasq_group }}"
    mode: "0640"
  loop: "{{ dnsmasq_dirs }}"

- name: DNSmasq | host lists from URL
  tags:
    - config
  get_url:
    url : "{{ item.value }}"
    dest: "{{ dnsmasq_conf_dir }}/hosts/{{ item.key }}"
    group: "{{ dnsmasq_group }}"
    mode: "0640"
  loop: "{{ dnsmasq_host_urls.items() }}"

- name: DNSmasq | logrotate
  tags:
    - logrotate
  template:
    src: logrotate.j2
    dest: /etc/logrotate.d/dnsmasq

- name: DNSMasq | service
  tags:
  - service
  service:
    name: dnsmasq
    state: started
    enabled: yes
