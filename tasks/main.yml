---

- name: DNSMasq | package
  tags:
  - package
  package:
    name: "{{ item }}"
  with_items:
    - dnsmasq
    - dnsmasq-utils

- name: DNSMasq | dirs
  tags:
  - dir
  file:
    path: "/etc/dnsmasq.d/{{ item }}"
    state: directory
    owner: dnsmasq
    group: dip
  with_items:
    - hosts
    - dhcp-hosts
    - dhcp-opts

- name: DNSmasq | config (template)
  tags:
  - config
  template:
    src : "{{ item.src }}.j2"
    dest: "{{ item.dest | d('/etc/' ~ item.src, true) }}"
    owner: dnsmasq
    group: dip
    mode: 0440
  with_items:
    - { src=dnsmasq.conf }
    - { src=dnsmasq.hosts, dest=/etc/dnsmasq.d/hosts/ }
    - { src=dnsmasq.servers, dest=/etc/dnsmasq.d/servers }
  notify: restart dnsmasq

- name: DNSmasq | config (copy)
  tags:
  - config
  copy:
    src : "{{ item.src  }}"
    dest: "{{ item.dest }}"
    owner: dnsmasq
    mode: 0440
  with_items: 
    - { src: dnsmasq.opts, dest: /etc/ }
    - { src: dnsmasq, dest: /etc/default/ }
  notify: reload dnsmasq

- name: DNSmasq | adblock list
  tags:
  - config
  get_url:
    url : "https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling-porn/hosts"
    dest: "/etc/dnsmasq.d/hosts/adblock"
  notify: reload dnsmasq

- name: DNSMasq | service
  tags:
  - service
  service:
    name: dnsmasq
    state: started
    enabled: yes
